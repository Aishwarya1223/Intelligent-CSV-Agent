AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Minimal CloudFormation stack to deploy Intelligent CSV Analyst on EC2 using the default VPC.
  Creates EC2, Security Group, ECR repo, S3 bucket, and Secrets Manager secret.

Parameters:
  ApplicationName:
    Type: String
    Default: intelligent-csv-analyst
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
  InstanceType:
    Type: String
    Default: t3.medium
  ContainerImage:
    Type: String
    Default: ""
    Description: Optional full image URI (e.g. 123456789012.dkr.ecr.us-east-1.amazonaws.com/repo:latest)
  SSHLocation:
    Type: String
    Default: 0.0.0.0/0
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: Select the default VPC from your account

Resources:

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP (8080) and SSH
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-sg'

  CsvBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub '${ApplicationName}-csv-${AWS::AccountId}'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

  LLMApiSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub '${ApplicationName}/llm-api-key'
      Description: Secret for LLM / OpenAI API keys
      GenerateSecretString:
        SecretStringTemplate: '{"note":"replace-with-actual-key"}'
        GenerateStringKey: secret
        ExcludePunctuation: true
        PasswordLength: 40
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete

  ECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub '${ApplicationName}-repo'
      ImageScanningConfiguration:
        ScanOnPush: true

  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ApplicationName}-ec2-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: CsvAccessPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub '${CsvBucket.Arn}'
                  - !Sub '${CsvBucket.Arn}/*'
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref LLMApiSecret

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  AppInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref LatestAmiId
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref EC2InstanceProfile
      SecurityGroupIds:
        - !Ref InstanceSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${ApplicationName}-ec2'
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y
          amazon-linux-extras install docker -y
          systemctl enable docker
          systemctl start docker

          REGION=${AWS::Region}
          ACCOUNT=${AWS::AccountId}
          REPO_URI="$${ACCOUNT}.dkr.ecr.$${REGION}.amazonaws.com/${ECRRepository}"

          if [ "${ContainerImage}" != "" ]; then
            IMAGE_URI="${ContainerImage}"
          else
            IMAGE_URI="$${REPO_URI}:latest"
          fi

          aws ecr get-login-password --region $${REGION} | docker login --username AWS --password-stdin $${ACCOUNT}.dkr.ecr.$${REGION}.amazonaws.com
          docker pull $${IMAGE_URI} || echo "Image not found, push to ECR first"
          docker run -d --name app -p 8080:8080 \
            -e CSV_BUCKET=${CsvBucket} \
            -e LLM_SECRET_ARN=${LLMApiSecret} \
            $${IMAGE_URI}

Outputs:
  InstancePublicIP:
    Description: Public IP of EC2 instance
    Value: !GetAtt AppInstance.PublicIp

  ECRRepositoryURI:
    Description: Push your Docker image here
    Value: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${ECRRepository}'

  CsvBucketName:
    Description: S3 bucket for CSV uploads
    Value: !Ref CsvBucket

  LLMSecretArn:
    Description: ARN of Secrets Manager secret
    Value: !Ref LLMApiSecret