flowchart LR
  %% compact labels, LR layout for less overlap
  T["Agent Flow: Intelligent CSV Analyst"]:::title
  classDef title fill:none,stroke:none,font-weight:bold,font-size:16px;

  subgraph UserSide
    U["User / Client &lpar;csv path, n_insights&rpar;"]
  end

  subgraph Orchestrator
    classDef orchestrator fill:#d0ebff,stroke:#0066cc,stroke-width:1.5px;
    class RA orchestrator;
    RA["ReportAgent"]
  end
  class RA orchestrator;
  subgraph Analysis["Analysis Subsystem"]
    DA["DataAnalystAgent &lpar;AssistantAgent + LLM&rpar;"]
    CSVT["CSV Tools: preview, summarize, correlations, generate_insights"]
  end

  subgraph Visualization["Visualization Subsystem"]
    VIZ["Viz Tools: hist, heatmap, scatter, top_corrs"]
  end

  subgraph Evaluation["Evaluation Subsystem"]
    EV["EvaluatorAgent &lpar;AssistantAgent&rpar;"]
  end
  
  AA["AssistantAgent &lpar;exec summary / polish&rpar;"]
  STORE["Storage &lpar;.md, .html, plots/&rpar;"]

  %% Flows (each arrow on its own line)
  U -->|submit CSV| RA
  RA -->|request analysis| DA
  DA -->|call tools| CSVT
  CSVT -->|summary / corrs| DA
  DA -->|insights_text| RA

  RA -->|generate visuals| VIZ
  VIZ -->|plot files| RA

  RA -->|evaluate insights| EV
  EV -->|evaluation JSON| RA

  RA -->|exec summary| AA
  AA -->|exec_summary| RA

  RA -->|save report| STORE
  STORE -->|report path| U

  classDef llm fill:#fff2cc,stroke:#b87300;
  class DA,EV,AA llm
